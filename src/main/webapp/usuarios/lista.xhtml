<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:p="http://primefaces.org/ui" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:f="http://xmlns.jcp.org/jsf/core" template="/WEB-INF/template.xhtml">

	<ui:define name="content">
		<div class="table-container">
			<h:form id="headerForm">
				<div class="table-header">
					<h2 class="table-title">
						<i class="pi pi-users" style="margin-right: .5rem;"></i> Gestão de
						Usuários
					</h2>
					<div class="table-actions">
						<p:commandButton value="Novo Usuário" icon="pi pi-plus"
							actionListener="#{usuarioBean.novoUsuario()}" oncomplete="PF('manageUsuarioDialog').show()"
							update="usuarioDialogForm" styleClass="ui-button-success ui-corporativo-btn"
							rendered="#{usuarioBean.admin}" />
					</div>
				</div>
			</h:form>

			<div class="card-body">
				<h:form id="usuarioListForm">
					<p:growl id="messages" closable="true" />
					<p:dataTable id="dt-usuarios" widgetVar="dtUsuarios" var="u" value="#{usuarioBean.usuarios}"
						globalFilterFunction="#{usuarioBean.globalFilterFunction}" reflow="true"
						styleClass="products-table" paginator="true" rows="10" paginatorPosition="bottom"
						emptyMessage="Nenhum usuário encontrado">
						<f:facet name="header">
							<div style="display: flex; justify-content: space-between; align-items: center;">
								<h:outputText value="Lista de Usuários" style="font-weight: 600; color: #37474f;" />
								<div style="display: flex; align-items: center; gap: 0.5em;">
									<h:outputText value="Buscar: " style="font-weight: 600; color: #37474f;" />
									<p:inputText id="globalFilter" onkeyup="PF('dtUsuarios').filter()"
										placeholder="Digite para buscar..." style="width:200px" />
								</div>
							</div>
						</f:facet>
						<p:column headerText="ID" sortBy="id" style="width: 100px;">
							<h:outputText value="#{u.id}" />
						</p:column>
						<p:column headerText="Nome" sortBy="nome">
							<h:outputText value="#{u.nome}" />
						</p:column>
						<p:column headerText="Usuário" sortBy="email">
							<h:outputText value="#{u.email}" />
						</p:column>
						<p:column headerText="Perfil" sortBy="perfil">
							<p:tag value="#{u.perfil.name()}"
								styleClass="#{u.perfil eq usuarioBean.perfilAdministrador ? 'ui-tag-danger' : 'ui-tag-info'}" />
						</p:column>
						<p:column exportable="false" headerText="Ações" style="text-align: center; width: 100px;">
							<div style="display: flex; justify-content: center; align-items: center; gap: 0.5rem;">
								<p:commandButton icon="pi pi-pencil" title="Editar" update=":usuarioDialog"
									oncomplete="PF('manageUsuarioDialog').show()"
									styleClass="ui-button-rounded ui-button-warning ui-button-sm"
									rendered="#{usuarioBean.admin}"
									disabled="#{u.email eq 'admin'}">
									<f:setPropertyActionListener value="#{u}" target="#{usuarioBean.usuario}" />
								</p:commandButton>
								<p:commandButton icon="pi pi-trash" title="Excluir"
									actionListener="#{usuarioBean.deletarUsuario(u)}"
									update=":usuarioListForm:dt-usuarios :usuarioListForm:messages"
									styleClass="ui-button-rounded ui-button-danger ui-button-sm"
									onclick="return confirm('Deseja realmente excluir este usuário?')"
									rendered="#{usuarioBean.admin}"
									disabled="#{u.email eq 'admin'}" />
							</div>
						</p:column>
					</p:dataTable>

				</h:form>
				<!-- Dialog fora do form principal, com form próprio -->
				<p:dialog id="usuarioDialog" header="" showEffect="fade" modal="true" widgetVar="manageUsuarioDialog"
					responsive="true" closeOnEscape="true" width="750" position="center"
					style="border-radius:12px; max-height: 90vh;">
					<p:panel styleClass="ui-panel ui-panel-corporativo"
						style="background: #fafbfc; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 0;">
						<f:facet name="header">
							<div style="display:flex; align-items:center; gap:0.8em; padding: 0.2em 1.5em 0.5em 1.5em;">
								<i class="pi pi-users" style="font-size:1.6em; color:#1976d2;"></i>
								<span
									style="font-size:1.4em; font-weight:600; color:#263238; letter-spacing:0.3px;">Cadastro
									de Usuário</span>
							</div>
						</f:facet>
						<h:form id="usuarioDialogForm">
							<div class="form-container">
								<div class="dialog-grid-corporativo">
									<div class="grid-item">
										<p:outputLabel for="nome" value="Nome " />
										<p:inputText id="nome" value="#{usuarioBean.usuario.nome}" required="true"
											placeholder="Nome completo do usuário"
											styleClass="ui-inputfield-corporativo" />
									</div>
									<div class="grid-item">
										<p:outputLabel for="usuario" value="Usuário " />
										<p:inputText id="usuario" value="#{usuarioBean.usuario.email}" required="true"
											placeholder="email@exemplo.com" styleClass="ui-inputfield-corporativo" />
									</div>
									<div class="grid-item">
										<p:outputLabel for="senha" value="Senha " />
										<p:password id="senha" value="#{usuarioBean.usuario.senha}" required="true"
											styleClass="ui-inputfield-corporativo"
											requiredMessage="A senha é obrigatória" toggleMask="true" redisplay="true"
											match="confirma" label="Senha" placeholder="Digite uma senha segura"
											validatorMessage="As senhas não coincidem." />
									</div>
									<div class="grid-item">
										<p:outputLabel for="confirma" value="Confirmar Senha " />
										<p:password id="confirma" value="#{usuarioBean.usuario.senha}" required="true"
											requiredMessage="A confirmação de senha é obrigatória" toggleMask="true"
											redisplay="true" placeholder="Digite a senha novamente"
											label="Confirmação de Senha" styleClass="ui-inputfield-corporativo" />
									</div>
									<div class="grid-item">
										<p:outputLabel for="perfil" value="Perfil " />
										<p:selectOneMenu id="perfil" value="#{usuarioBean.usuario.perfil}"
											required="true" converter="perfilUsuarioConverter"
											styleClass="ui-inputfield-corporativo">
											<f:selectItem itemLabel="Selecione o perfil" itemValue="#{null}" />
											<f:selectItems value="#{usuarioBean.perfisUsuario}" var="perfil"
												itemLabel="#{perfil.name()}" itemValue="#{perfil}" />
										</p:selectOneMenu>
									</div>
								</div>
							</div> <!-- Fechamento da form-container -->
							<div class="dialog-footer-corporativo">
								<p:commandButton value="Cancelar" icon="pi pi-times"
									onclick="PF('manageUsuarioDialog').hide(); return false;"
									styleClass="ui-button-secondary ui-button-outlined"
									style="min-width: 110px; padding: 0.75em 1.5em; border-radius: 8px; border: 2px solid #64748b; color: #64748b; background: white; font-weight: 500; transition: all 0.2s ease;"
									immediate="true" />
								<p:commandButton
									value="#{usuarioBean.usuario != null and usuarioBean.usuario.id != null ? 'Atualizar' : 'Cadastrar'}"
									icon="pi pi-check" actionListener="#{usuarioBean.salvarUsuario()}"
									update=":usuarioListForm:dt-usuarios :usuarioListForm:messages"
									oncomplete="if(!args.validationFailed) PF('manageUsuarioDialog').hide();"
									styleClass="ui-button-success"
									style="min-width: 110px; padding: 0.75em 1.5em; border-radius: 8px; background: linear-gradient(135deg, #1976d2, #1565c0); border: none; color: white; font-weight: 600; box-shadow: 0 4px 12px rgba(25,118,210,0.3); transition: all 0.2s ease;"
									process="@form" />
							</div>
						</h:form>
					</p:panel>
					<style>
						.dialog-grid-corporativo {
							display: grid;
							grid-template-columns: 1fr 1fr;
							gap: 1.2em 1.8em;
							margin-bottom: 1em;
							margin-top: 0.8em;
							align-items: end;
						}

						.dialog-grid-corporativo .grid-item {
							display: flex;
							flex-direction: column;
							gap: 0.4em;
						}

						.dialog-grid-corporativo .grid-item-full {
							grid-column: 1 / 3;
						}

						.dialog-grid-corporativo .ui-outputlabel {
							font-weight: 600;
							color: #37474f;
							font-size: 0.95em;
							margin-bottom: 0.3em;
						}

						.ui-inputfield-corporativo {
							width: 100%;
							border-radius: 8px;
							border: 1px solid #cfd8dc;
							background: #fff;
							padding: 0.65em 0.8em;
							font-size: 0.95em;
							box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
							transition: all 0.2s ease;
							min-height: 2.5em;
							box-sizing: border-box;
						}

						.ui-inputfield-corporativo:focus {
							border-color: #1976d2;
							outline: none;
							box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
						}

						.ui-selectonemenu.ui-inputfield-corporativo {
							padding: 0;
						}

						.ui-selectonemenu.ui-inputfield-corporativo .ui-selectonemenu-label {
							padding: 0.65em 0.8em;
							border: none;
							background: transparent;
						}

						.ui-panel-corporativo {
							border: none;
						}

						.ui-dialog .ui-dialog-content {
							padding: 0;
						}

						/* Calendar field fixes */
						.ui-calendar.ui-inputfield-corporativo {
							border: none;
							border-radius: 8px;
							background: #fff;
							padding: 0;
							box-shadow: none;
						}

						.ui-calendar.ui-inputfield-corporativo .ui-inputtext {
							border: none;
							box-shadow: none;
							padding: 0.65em 0.8em;
							border-radius: 8px 0 0 8px;
						}

						.ui-calendar.ui-inputfield-corporativo .ui-datepicker-trigger {
							border: none;
							background: #f8f9fa;
							border-radius: 0 8px 8px 0;
							color: #1976d2;
						}

						.ui-calendar.ui-inputfield-corporativo:focus-within {
							border: none;
							box-shadow: none;
						}

						@media (max-width: 768px) {
							.dialog-grid-corporativo {
								grid-template-columns: 1fr;
								gap: 1em;
							}

							.dialog-grid-corporativo .grid-item-full {
								grid-column: 1;
							}
						}

						/* Hover effects for buttons */
						.ui-button-secondary.ui-button-outlined:hover {
							background: #64748b !important;
							color: white !important;
							transform: translateY(-1px);
							box-shadow: 0 4px 12px rgba(100, 116, 139, 0.3) !important;
						}

						.ui-button-success:hover {
							transform: translateY(-1px);
							box-shadow: 0 6px 16px rgba(25, 118, 210, 0.4) !important;
						}

						/* Focus effects */
						.ui-inputfield-corporativo:focus,
						.ui-selectonemenu.ui-inputfield-corporativo:focus-within {
							transform: translateY(-1px);
							box-shadow: 0 6px 20px rgba(25, 118, 210, 0.15) !important;
						}
					</style>
				</p:dialog>
			</div>
		</div>
	</ui:define>
</ui:composition>