<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:p="http://primefaces.org/ui" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
    xmlns:f="http://xmlns.jcp.org/jsf/core" xmlns:o="http://omnifaces.org/ui" template="/WEB-INF/template.xhtml">

    <ui:define name="content">
        <div class="table-container">
            <!-- Componente OmniFaces para melhor tratamento de erros -->
            <o:messages var="message">
                <div
                    class="alert alert-#{message.severity.ordinal == 0 ? 'info' : message.severity.ordinal == 1 ? 'warning' : 'danger'}">
                    <strong>#{message.summary}</strong> #{message.detail}
                </div>
            </o:messages>

            <h:form id="headerForm">
                <div class="table-header">
                    <h2 class="table-title">
                        <i class="pi pi-sitemap" style="margin-right: .5rem;"></i>
                        Gestão de Processos
                    </h2>
                    <div class="table-actions">
                        
                        <p:commandButton value="Novo Processo" icon="pi pi-plus"
                            actionListener="#{processoBean.novoProcesso()}"
                            update="manageProcessoDialog :processoDetailForm"
                            oncomplete="PF('manageProcessoDialog').show()" styleClass="ui-button-success ui-corporativo-btn" />
                        <p:commandButton value="Atualizar Lista" icon="pi pi-refresh"
                            actionListener="#{processoBean.carregarProcessos()}"
                            update=":processoListForm:dt-processos :processoListForm:messages"
                            styleClass="ui-button-secondary ui-corporativo-btn" />
                    </div>
                </div>
            </h:form>

            <div class="card-body">
                <h:form id="processoListForm">
                    <p:growl id="messages"  closable="true" />

                    <!-- DataTable com lazy loading melhorado - Versão simplificada -->
                    <p:dataTable id="dt-processos" widgetVar="dtProcessos" var="proc"
                        value="#{processoBean.processos}"
                        globalFilterFunction="#{processoBean.globalFilterFunction}"
                        reflow="true" styleClass="products-table" selection="#{processoBean.selectedProcessos}"
                        rowKey="#{proc.id}" paginator="true" rows="10" rowSelectMode="checkbox"
                        paginatorPosition="bottom" emptyMessage="Nenhum processo encontrado">
                        <f:facet name="header">
							<div style="display: flex; justify-content: space-between; align-items: center;">
								<h:outputText value="Lista de Processos" style="font-weight: 600; color: #37474f;" />
								<div style="display: flex; align-items: center; gap: 0.5em;">
									<h:outputText value="Buscar: " style="font-weight: 600; color: #37474f;" />
									<p:inputText id="globalFilter" onkeyup="PF('dtProcessos').filter()"
										placeholder="Digite para buscar..." style="width:200px" />
								</div>
							</div>
						</f:facet>

                        <p:column style="width:40px" exportable="false">
                            <p:rowToggler />
                        </p:column>
                        
                        <p:column headerText="ID" sortBy="id" width="80">
                            <h:outputText value="#{proc.id}" />
                        </p:column>

                        <p:column headerText="Cliente" sortBy="cliente" style="width: 25%;">
                            <h:outputText value="#{proc.cliente.razaoSocial}" title="#{proc.cliente.razaoSocial}" />
                        </p:column>

                        <p:column headerText="Título" sortBy="titulo"  style="width: 30%;">
                            <h:outputText value="#{proc.titulo}" title="#{proc.titulo}" />
                        </p:column>

                        <p:column headerText="Status" sortBy="status" filterBy="#{proc.status}" filterMatchMode="exact"
                            width="120">
                            <f:facet name="filter">
                                <p:selectOneMenu onchange="PF('dtProcessos').filter()">
                                    <f:selectItem itemLabel="Todos" itemValue="#{null}" noSelectionOption="true" />
                                    <f:selectItem itemLabel="Aberto" itemValue="ABERTO" />
                                    <f:selectItem itemLabel="Cancelado" itemValue="CANCELADO" />
                                    <f:selectItem itemLabel="Concluído" itemValue="CONCLUIDO" />
                                	<f:selectItem itemLabel="Em Andamento" itemValue="EM_ANDAMENTO" />
                                	<f:selectItem itemLabel="Parado" itemValue="PARADO" />
                                </p:selectOneMenu>
                            </f:facet>
                            <p:tag styleClass="#{
                                    proc.status == 'CONCLUIDO' ? 'status-concluido' :
                                    proc.status == 'ABERTO' ? 'status-aberto' :
                                    proc.status == 'EM_ANDAMENTO' ? 'status-andamento' :
                                    proc.status == 'PARADO' ? 'status-parado' :
                                    proc.status == 'CANCELADO' ? 'status-cancelado' :
                                    proc.status == 'PENDENTE' ? 'status-pendente' :
                                    ''
                                }" value="#{proc.status}" />
                        </p:column>

                        <p:column headerText="Data Criação" sortBy="dataCriacao" width="130">
                            <h:outputText value="#{proc.dataCriacao}" rendered="#{proc.dataCriacao != null}">
                                <f:converter converterId="localDateTimeConverter" />
                            </h:outputText>
                            <h:outputText value="N/A" rendered="#{proc.dataCriacao == null}" styleClass="text-muted" />
                        </p:column>

                        <p:column exportable="false" headerText="Ações" width="140">
                            <div style="display: flex; gap: 0.5rem;">
                                <p:commandButton icon="pi pi-pencil" title="Editar"
                                    actionListener="#{processoBean.carregarProcesso(proc)}"
                                    oncomplete="PF('manageProcessoDialog').show()" update=":processoDetailForm"
                                    styleClass="ui-button-rounded ui-button-warning ui-button-sm" />
                                <p:commandButton icon="pi pi-trash" title="Excluir"
                                    actionListener="#{processoBean.deletarProcesso(proc)}"
                                    update="dt-processos messages"
                                    styleClass="ui-button-rounded ui-button-danger ui-button-sm"
                                    onclick="return confirm('Deseja realmente excluir este processo?')" />
                                <p:commandButton icon="pi pi-search" title="Ver Detalhes"
                                    action="#{processoBean.visualizarProcesso(proc)}"
                                    styleClass="ui-button-rounded ui-button-info ui-button-sm" />
                            </div>
                        </p:column>
                        <p:rowExpansion>
                            <div style="padding:1rem 2rem;">
                                <h3 style="margin:0 0 0.5rem 0; color:#1976d2;">Etapas do Processo</h3>
                                <h:panelGroup rendered="#{not empty proc.etapas}">
                                    <ui:repeat value="#{proc.etapas}" var="etapa">
                                        <div style="display:flex;align-items:center;gap:0.7rem;margin-bottom:0.7rem;">
                                            <i class="pi pi-circle-on" style="font-size:1.1rem; color:
                                                #{etapa.status == 'CONCLUIDO' ? '#388e3c' :
                                                  etapa.status == 'ABERTO' ? '#1976d2' :
                                                  etapa.status == 'EM_ANDAMENTO' ? '#fbc02d' :
                                                  etapa.status == 'PARADO' ? '#e64a19' :
                                                  etapa.status == 'CANCELADO' ? '#757575' :
                                                  etapa.status == 'PENDENTE' ? '#ff9800' : '#888'};"></i>
                                            <span style="font-weight:600;">#{etapa.etapaDisponivel.titulo}</span>
                                            <span style="font-size:0.95rem; color:#666;">(#{etapa.status})</span>
                                        </div>
                                    </ui:repeat>
                                </h:panelGroup>
                                <h:outputText value="Nenhuma etapa encontrada." rendered="#{empty proc.etapas}" style="color:#888;" />
                            </div>
                        </p:rowExpansion>
                    </p:dataTable>
                </h:form>

                <!-- Diálogo de detalhes do processo -->
                <p:dialog header="" dynamic="true"
                    showEffect="fade" modal="true" widgetVar="manageProcessoDialog" id="manageProcessoDialog"
                    responsive="true" closeOnEscape="true" 
                    width="1200" 
                    position="center"
                    style="border-radius:12px; max-height: 90vh;">
                    <p:panel styleClass="ui-panel ui-panel-corporativo" style="background: #fafbfc; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 0;">
                        <f:facet name="header">
                            <div style="display:flex; align-items:center; gap:0.8em; padding: 1.5em 1.5em 0.5em 1.5em;">
                                <i class="pi pi-sitemap" style="font-size:1.6em; color:#1976d2;"></i>
                                <span style="font-size:1.4em; font-weight:600; color:#263238; letter-spacing:0.3px;">Cadastro de Processo</span>
                            </div>
                        </f:facet>
                        <h:form id="processoDetailForm">
                            <div class="form-container" style="padding: 0 1.5em 1em 1.5em;">
                                <div class="dialog-grid-corporativo">
                                    <div class="grid-item">
                                        <p:outputLabel for="titulo" value="Título " />
                                        <p:inputText id="titulo" value="#{processoBean.processo.titulo}" required="true"
                                            placeholder="Digite o título do processo" styleClass="ui-inputfield-corporativo" />
                                    </div>
                                    <div class="grid-item">
                                        <p:outputLabel for="tipoProcesso" value="Tipo de Processo " />
                                        <p:selectOneMenu id="tipoProcesso" value="#{processoBean.processo.tipoProcesso}"
                                            converter="#{tipoProcessoConverter}" required="true" styleClass="ui-inputfield-corporativo">
                                            <f:selectItem itemLabel="Selecione o tipo" itemValue="#{null}" />
                                            <f:selectItems value="#{processoBean.tiposProcesso}" var="tp"
                                                itemLabel="#{tp.nome}" itemValue="#{tp}" />
                                        </p:selectOneMenu>
                                    </div>
                                    <div class="grid-item">
                                        <p:outputLabel for="cliente" value="Cliente " />
                                        <p:selectOneMenu id="cliente" value="#{processoBean.clienteId}" required="true" 
                                            styleClass="ui-inputfield-corporativo" filter="true" filterMatchMode="contains" filterPlaceholder="Filtrar clientes...">
                                            <f:selectItem itemLabel="Selecione o cliente" itemValue="" noSelectionOption="true" />
                                            <f:selectItems value="#{processoBean.clientes}" var="cli"
                                                itemLabel="#{cli.razaoSocial} - #{cli.documento}" itemValue="#{cli.id}" />
                                        </p:selectOneMenu>
                                    </div>
                                    <div class="grid-item">
                                        <p:outputLabel for="responsavel" value="Responsável" />
                                        <p:selectOneMenu id="responsavel" value="#{processoBean.processo.responsavel}"
                                            converter="#{usuarioConverter}" styleClass="ui-inputfield-corporativo" 
                                            filter="true" filterMatchMode="contains" filterPlaceholder="Filtrar responsáveis...">
                                            <f:selectItem itemLabel="Selecione o responsável" itemValue="#{null}" />
                                            <f:selectItems value="#{processoBean.responsaveis}" var="resp"
                                                itemLabel="#{resp.nome}" itemValue="#{resp}" />
                                        </p:selectOneMenu>
                                    </div>
                                    <div class="grid-item">
                                        <p:outputLabel for="licenciamentoAssociado" value="Licenciamento" />
                                        <p:selectOneMenu id="licenciamentoAssociado" 
                                            value="#{processoBean.licenciamentoIdSelecionado}"
                                            styleClass="ui-inputfield-corporativo" 
                                            filter="true" filterMatchMode="contains" filterPlaceholder="Filtrar licenciamentos...">
                                            <f:selectItem itemLabel="Nenhum licenciamento" itemValue="" noSelectionOption="true" />
                                            <f:selectItems value="#{processoBean.licenciamentos}" var="lic"
                                                itemLabel="#{lic.tipo.nome} - #{lic.cliente.razaoSocial}" itemValue="#{lic.id}" />
                                        </p:selectOneMenu>
                                    </div>
                                    <div class="grid-item">
                                        <p:outputLabel for="statusProcesso" value="Status" />
                                        <p:selectOneMenu id="statusProcesso" value="#{processoBean.processo.status}" styleClass="ui-inputfield-corporativo">
                                            <f:selectItems value="#{processoBean.statusProcessos}" var="st"
                                                itemLabel="#{st}" itemValue="#{st}" />
                                        </p:selectOneMenu>
                                    </div>
                                    <div class="grid-item">
                                        <p:outputLabel for="dataPrevisao" value="Previsão de Conclusão" />
                                        <p:calendar id="dataPrevisao"
                                            value="#{processoBean.processo.dataPrevisaoFinalizacao}" pattern="dd/MM/yyyy"
                                            mask="true" showOn="button" navigator="true" monthNavigator="true"
                                            yearNavigator="true" locale="pt_BR" showButtonPanel="true" 
                                            styleClass="ui-inputfield-corporativo"
                                            style="width: 100%; display: block;">
                                            <f:converter converterId="robustLocalDateConverter" />
                                        </p:calendar>
                                    </div>
                                    <div class="grid-item">
                                        <p:outputLabel for="taxaValorTotal" value="Valor Total (R$)" />
                                        <p:inputNumber id="taxaValorTotal" value="#{processoBean.processo.taxaValorTotal}"
                                            symbol="R$" symbolPosition="p" decimalSeparator="," thousandSeparator="."
                                            decimalPlaces="2" styleClass="ui-inputfield-corporativo" />
                                    </div>
                                    <div class="grid-item grid-item-full">
                                        <p:outputLabel for="descricao" value="Observações" />
                                        <p:inputTextarea id="descricao" value="#{processoBean.processo.descricao}" rows="3"
                                            placeholder="Digite observações sobre o processo (opcional)" counter="display" maxlength="1000"
                                            counterTemplate="{0} caracteres restantes"
                                            style="width: 100%; resize: vertical;" styleClass="ui-inputfield-corporativo" />
                                        <h:outputText id="display" class="block" style="font-size: 0.85em; color: #666; margin-top: 0.25em;" />
                                    </div>
                                </div>

                                <!-- Tabela de etapas do processo (edição) -->
                                <p:outputPanel rendered="#{not empty processoBean.etapasDoProcesso}">
                                    <h3 style="margin-top:1em; color:#1976d2;">Etapas do Processo</h3>
                                    <p:dataTable id="tabelaEtapasProcesso" value="#{processoBean.etapasDoProcesso.stream().sorted((e1,e2) -> e1.ordem.compareTo(e2.ordem)).toList()}" var="etapa" size="small" style="margin-bottom:1em;">
                                        <p:column headerText="Ordem" width="60">
                                            <h:outputText value="#{etapa.ordem}" />
                                        </p:column>
                                        <p:column headerText="Título da Etapa">
                                            <h:outputText value="#{etapa.etapaDisponivel.titulo}" />
                                        </p:column>
                                        <p:column headerText="Status" width="120">
                                            <h:outputText value="#{etapa.status}" />
                                        </p:column>
                                        <p:column headerText="Ações" width="120">
                                            <p:commandButton icon="pi pi-arrow-up" title="Mover para cima" actionListener="#{processoBean.moverEtapaParaCima(etapa)}" update=":processoDetailForm:tabelaEtapasProcesso" disabled="#{etapa.ordem == 1}" styleClass="ui-button-secondary ui-button-flat ui-button-sm" />
                                            <p:commandButton icon="pi pi-arrow-down" title="Mover para baixo"
                                                actionListener="#{processoBean.moverEtapaParaBaixo(etapa)}"
                                                update=":processoDetailForm:tabelaEtapasProcesso"
                                                styleClass="ui-button-secondary ui-button-flat ui-button-sm"
                                                disabled="#{etapa.ordem == processoBean.etapasDoProcesso.size()}" />
                                        </p:column>
                                    </p:dataTable>
                                </p:outputPanel>
                            </div>
                            <div class="dialog-footer-corporativo" style="background: linear-gradient(to bottom, #fafbfc, #f5f7fa); border-top: 1px solid #e1e5e9; padding: 1.2em 1.5em 1em 1.5em; margin: 1em -1.5em 0 -1.5em; display: flex; justify-content: flex-end; gap: 1em; border-radius: 0 0 10px 10px;">
                                <p:commandButton value="Cancelar" icon="pi pi-times"
                                    onclick="PF('manageProcessoDialog').hide(); return false;"
                                    styleClass="ui-button-secondary ui-button-outlined"
                                    style="min-width: 110px; padding: 0.75em 1.5em; border-radius: 8px; border: 2px solid #64748b; color: #64748b; background: white; font-weight: 500; transition: all 0.2s ease;"
                                    immediate="true" />
                                <p:commandButton value="#{processoBean.processo != null and processoBean.processo.id != null ? 'Atualizar' : 'Cadastrar'}" icon="pi pi-check"
                                    actionListener="#{processoBean.salvarProcesso()}"
                                    update=":processoListForm:dt-processos :processoListForm:messages"
                                    styleClass="ui-button-success"
                                    style="min-width: 110px; padding: 0.75em 1.5em; border-radius: 8px; background: linear-gradient(135deg, #1976d2, #1565c0); border: none; color: white; font-weight: 600; box-shadow: 0 4px 12px rgba(25,118,210,0.3); transition: all 0.2s ease;"
                                    oncomplete="if(!args.validationFailed) PF('manageProcessoDialog').hide();"
                                    process="@form" />
                            </div>
                        </h:form>
                    </p:panel>
                    <style>
                        .dialog-grid-corporativo {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 1.2em 1.8em;
                            margin-bottom: 1em;
                            margin-top: 0.8em;
                            align-items: end;
                        }
                        
                        .dialog-grid-corporativo .grid-item {
                            display: flex;
                            flex-direction: column;
                            gap: 0.4em;
                        }
                        
                        .dialog-grid-corporativo .grid-item-full {
                            grid-column: 1 / 3;
                        }
                        
                        .dialog-grid-corporativo .ui-outputlabel {
                            font-weight: 600;
                            color: #37474f;
                            font-size: 0.95em;
                            margin-bottom: 0.3em;
                        }
                        
                        .ui-inputfield-corporativo {
                            width: 100%;
                            border-radius: 8px;
                            border: 1px solid #cfd8dc;
                            background: #fff;
                            font-size: 0.95em;
                            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
                            transition: all 0.2s ease;
                            min-height: 2.5em;
                            box-sizing: border-box;
                        }
                        
                        .ui-inputfield-corporativo:focus {
                            border-color: #1976d2;
                            outline: none;
                            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
                        }
                        
                        .ui-selectonemenu.ui-inputfield-corporativo {
                            padding: 0;
                        }
                        
                        .ui-selectonemenu.ui-inputfield-corporativo .ui-selectonemenu-label {
                            padding: 0.65em 0.8em;
                            border: none;
                            background: transparent;
                        }
                        
                        .ui-calendar.ui-inputfield-corporativo {
                            padding: 0;
                            width: 100% !important;
                            display: block !important;
                            border: none !important;
                            box-shadow: none !important;
                        }
                        
                        .ui-calendar.ui-inputfield-corporativo .ui-inputtext {
                            border: none;
                            padding: 0.65em 0.8em;
                            border-radius: 8px 0 0 8px;
                            width: calc(100% - 42px) !important;
                            box-shadow: none;
                        }
                        
                        .ui-inputnumber.ui-inputfield-corporativo .ui-inputtext {
                            border: none;
                            padding: 0.65em 0.8em;
                            background: transparent;
                        }
                       
                        .ui-panel-corporativo {
                            border: none;
                        }
                        
                        .ui-dialog .ui-dialog-content {
                            padding: 0;
                        }
                        
                        @media (max-width: 768px) {
                            .dialog-grid-corporativo {
                                grid-template-columns: 1fr;
                                gap: 1em;
                            }
                            .dialog-grid-corporativo .grid-item-full {
                                grid-column: 1;
                            }
                        }
                        
                        /* Dialog centralizado com tamanho consistente */
                        /* Removido width fixo para permitir ajuste pelo atributo width do componente */
                        #manageProcessoDialog .ui-dialog-content {
                            padding: 0 !important;
                        }
                        
                        /* Hover effects for buttons */
                        .ui-button-secondary.ui-button-outlined:hover {
                            background: #64748b !important;
                            color: white !important;
                            transform: translateY(-1px);
                            box-shadow: 0 4px 12px rgba(100,116,139,0.3) !important;
                        }
                        
                        .ui-button-success:hover {
                            transform: translateY(-1px);
                            box-shadow: 0 6px 16px rgba(25,118,210,0.4) !important;
                        }
                        
                        /* Labels styling */
                        .dialog-grid-corporativo .ui-outputlabel {
                            font-weight: 600;
                            color: #374151;
                            font-size: 0.95em;
                            margin-bottom: 0.3em;
                        }
                        
                        /* Focus effects */
                        .ui-inputfield-corporativo:focus,
                        .ui-selectonemenu.ui-inputfield-corporativo:focus-within,
                        .ui-calendar.ui-inputfield-corporativo:focus-within {
                            transform: translateY(-1px);
                            box-shadow: 0 6px 20px rgba(25,118,210,0.15) !important;
                        }
                    </style>
                </p:dialog>
            </div>
        </div>
    </ui:define>
</ui:composition>